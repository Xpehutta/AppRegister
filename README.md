# Сервис ИНД заявок

Данный проект представляет собой веб‑сервис для управления заявками ИНД. Он позволяет пользователям создавать, отправлять и отслеживать заявки с гибкими формами, прикреплять файлы и получать обновления статуса. Администраторы могут просматривать заявки, изменять их статусы и оставлять комментарии. Приложение построено с возможностью простого развёртывания в собственной инфраструктуре с использованием Docker.

## Пользовательский сценарий

В этом разделе описаны типичные шаги, которые выполняет пользователь для регистрации, заполнения заявки и отслеживания её статуса.

### 1. Регистрация

- Откройте приложение в браузере (`http://localhost`).
- Нажмите **Регистрация** в панели навигации.
- Заполните регистрационную форму:
  - **Email** – действующий адрес электронной почты.
  - **Пароль** – не менее 6 символов.
  - **Имя**
  - **Фамилия**
- Нажмите **Зарегистрироваться**.  
  В случае успеха вы будете перенаправлены на страницу входа.

![Registration](data/Regis.png)

### 2. Вход в систему

- На странице входа введите ваш **Email** и **Пароль**.
- Нажмите **Войти**.  
  После успешной аутентификации вы попадёте в личный кабинет – **Мои заявки**.

 ![Login](data/SignUp.png) 

### 3. Личный кабинет – Мои заявки

- На панели отображается список всех созданных вами заявок с указанием:
  - **ID** – уникальный идентификатор.
  - **Статус** – например, черновик, отправлена, на рассмотрении, принята, отклонена.
  - **Дата подачи** – заполняется только после отправки.
  - **Дата создания**.
  - **Действия** – ссылка для просмотра деталей заявки.
- Чтобы создать новую заявку, нажмите кнопку **Создать новую заявку**.

![Dashboard](data/MyApps.png) 

### 4. Создание новой заявки

- Перед вами форма, поля которой определяются администратором системы (на основе листа "Интегрированный набор данных" шаблона).  
  Обычно поля могут включать:
  - Описание сценария (текстовое поле)
  - Маппинг на имеющийся набор данных (текстовое поле)
  - Набор мастер-источников (текст)
  - Глубина бизнес-истории (текст)
  - Актуальность (выпадающий список с предопределёнными значениями)
  - Желаемый срок реализации и обоснование (выбор даты)
  - и другие, в зависимости от конфигурации.
- Заполните все обязательные поля (помечены `*`).
- Нажмите **Создать черновик**.  
  Заявка сохраняется со статусом **черновик**, и вы перенаправляетесь на страницу её деталей.

![New](data/NewApp.png) 

### 5. Добавление вложений (необязательно)

- На странице деталей заявки прокрутите до раздела **Вложения**.
- Нажмите **Выберите файл**, выберите документ (PDF, изображение, Word и т.п.), затем нажмите **Загрузить**.  
  Файл сохраняется в локальном хранилище, и его имя появляется в списке вложений.
- Вы можете загрузить несколько файлов, пока заявка находится в статусе черновика.

### 6. Отправка заявки

- Когда вы закончили заполнение формы и загрузку всех необходимых файлов, нажмите кнопку **Отправить заявку**.
- Статус изменяется на **отправлена**.  
  Если настроены email‑уведомления, вы получите подтверждающее письмо.
- После отправки вы больше не можете редактировать форму или загружать новые файлы (если только администратор не вернёт заявку в черновик).

![Sub](data/AppDetails.png) 

### 7. Отслеживание статуса заявки

- Вернитесь в личный кабинет (**Мои заявки**), чтобы увидеть обновлённый статус.
- Возможные статусы:
  - **draft** – ещё не отправлена.
  - **submitted** – ожидает рассмотрения.
  - **under_review** – рассматривается администратором.
  - **accepted** – одобрена.
  - **rejected** – отклонена (с возможным комментарием).
- Нажмите на любую заявку, чтобы просмотреть её детали, включая введённые вами данные и комментарии администратора.

### 8. Действия администратора (для справки)

Администраторы обладают дополнительными возможностями:
- Просмотр всех заявок (всех пользователей) через **Админ панель**.
- Изменение статуса любой заявки и оставление комментария.
- Управление конфигурацией метаданных интегрированного набора данных через страницу **Настройка набора данных**.

Данный сценарий охватывает полный путь пользователя от регистрации до получения решения по заявке.

## Возможности

- Регистрация и аутентификация пользователей (JWT).
- Динамические формы заявок, настраиваемые через простой JavaScript‑файл (поля основаны на шаблоне "Интегрированный набор данных").
- Загрузка файлов (резюме, документы) с хранением в локальной инфраструктуре.
- Личный кабинет для просмотра, создания и отправки заявок.
- Панель администратора для просмотра всех заявок и изменения их статусов.
- Интерфейс администратора для управления метаданными набора данных (согласно предоставленному шаблону Excel).
- Интерфейс на русском языке (можно переключить на английский, изменив код).
- Полная контейнеризация с помощью Docker и Docker Compose.

## Технологический стек

- **Бэкенд:** Node.js + Express (TypeScript)
- **База данных:** PostgreSQL (с JSONB для гибкого хранения данных заявок)
- **Фронтенд:** React (создан с помощью Create React App)
- **Обратный прокси:** Nginx (отдаёт фронтенд и проксирует API-запросы)
- **Хранилище файлов:** локальная директория (монтируется в контейнеры)
- **Контейнеризация:** Docker, Docker Compose

## Предварительные требования

- [Docker](https://www.docker.com/products/docker-desktop) (версия 20.10+)
- [Docker Compose](https://docs.docker.com/compose/) (обычно входит в состав Docker Desktop)
- [Git](https://git-scm.com/) (необязательно, для клонирования)

## Начало работы

### 1. Клонирование репозитория

```bash
git clone https://github.com/your-username/user-app-service.git
cd user-app-service
```

### 2. Создание файла конфигурации окружения

Скопируйте пример файла окружения и при необходимости измените значения:

```bash
cp .env.example .env
```

Отредактируйте `.env`, указав учётные данные базы данных, секретный ключ JWT и настройки SMTP (если нужны email‑уведомления).  
**Важно:** храните этот файл в безопасности и никогда не добавляйте его в систему контроля версий.

### 3. Сборка и запуск контейнеров

```bash
docker-compose build
docker-compose up -d
```

Будут созданы и запущены три контейнера:
- `app-db` – PostgreSQL
- `app-node` – бэкенд на Node.js
- `app-nginx` – веб‑сервер Nginx

### 4. Инициализация схемы базы данных

Необходимо создать таблицы. Выполните:

```bash
docker exec -it app-db psql -U appuser -d appdb
```

Затем выполните следующий SQL (можно также запустить его из файла):

```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    role TEXT DEFAULT 'user',
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE profiles (
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    first_name TEXT,
    last_name TEXT,
    phone TEXT
);

CREATE TABLE applications (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    status TEXT NOT NULL,
    submitted_at TIMESTAMP,
    data JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE attachments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    application_id UUID REFERENCES applications(id) ON DELETE CASCADE,
    filename TEXT NOT NULL,
    file_path TEXT NOT NULL,
    uploaded_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE reviews (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    application_id UUID REFERENCES applications(id) ON DELETE CASCADE,
    admin_id UUID REFERENCES users(id),
    comment TEXT,
    new_status TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Добавление пользователя-администратора по умолчанию (пароль: "password")
INSERT INTO users (email, password_hash, role) VALUES (
    'admin@example.com',
    '$2b$10$eL9yI6qX3Fz5sVtZzLZQK.6bJqyX0Fz5sVtZzLZQK.6bJqyX0Fz5s',
    'admin'
);
\q
```

> **Примечание:** Указанный bcrypt‑хеш соответствует строке `"password"`. После первого входа следует сменить пароль.

### 5. Сборка фронтенда

Исходный код фронтенда находится в папке `frontend/`. Для создания production‑сборки выполните:

```bash
cd frontend
npm install
npm run build
```

Если Node.js не установлен локально, можно использовать Docker:

```bash
cd ~/user-app-service
docker run --rm -v $(pwd)/frontend:/app -w /app node:18-alpine sh -c "npm install && npm run build"
```

Собранные файлы будут помещены в `frontend/build` и автоматически обслуживаться Nginx.

### 6. Доступ к приложению

Откройте браузер и перейдите по адресу `http://localhost`. Вы должны увидеть страницу входа.

- Зарегистрируйте нового пользователя или войдите как `admin@example.com` / `password`.
- Администратору доступны дополнительные разделы: **Админ панель** и **Настройка набора данных**.

## Структура проекта

```
.
├── backend/                # Исходный код бэкенда на Node.js
│   ├── src/
│   │   ├── config/         # Конфигурация окружения и БД
│   │   ├── controllers/    # Контроллеры маршрутов
│   │   ├── middleware/     # Аутентификация, валидация, обработка ошибок
│   │   ├── models/         # Запросы к БД (опционально)
│   │   ├── routes/         # Маршруты Express
│   │   ├── services/       # Email, работа с файлами
│   │   ├── utils/          # Логирование, схемы валидации
│   │   └── index.ts        # Точка входа
│   ├── Dockerfile
│   └── package.json
├── frontend/               # Фронтенд на React
│   ├── public/
│   ├── src/
│   │   ├── components/     # Компоненты React
│   │   ├── api.js          # Axios‑клиент для API
│   │   ├── App.js
│   │   ├── formConfig.js   # Определения полей формы заявки
│   │   └── ...
│   └── package.json
├── nginx/
│   └── default.conf        # Конфигурация Nginx
├── uploads/                # Локальное хранилище файлов (создаётся при работе)
├── docker-compose.yml
├── .env.example            # Пример файла переменных окружения
└── README.md
```

## Переменные окружения

В файле `.env` необходимы следующие переменные:

| Переменная       | Описание                                  | Пример                  |
|------------------|-------------------------------------------|-------------------------|
| DB_USER          | Пользователь PostgreSQL                   | appuser                 |
| DB_PASSWORD      | Пароль PostgreSQL                         | strongpassword          |
| DB_NAME          | Имя базы данных                           | appdb                   |
| JWT_SECRET       | Секрет для подписи JWT                     | your‑secret‑key         |
| SMTP_HOST        | SMTP‑сервер                               | smtp.example.com        |
| SMTP_PORT        | Порт SMTP                                 | 587                     |
| SMTP_USER        | Имя пользователя SMTP                      | user@example.com        |
| SMTP_PASS        | Пароль SMTP                               |                         |

Настройки SMTP необязательны; при их отсутствии email‑уведомления отключаются.

## Настройка формы заявки

Поля, отображаемые на странице «Новая заявка», определяются в файле `frontend/src/formConfig.js`. Вы можете добавлять, удалять или изменять поля в соответствии с требованиями. Каждый объект поля может содержать:

- `name`: ключ в JSON (сохраняется в `application.data`)
- `label`: отображаемая подпись
- `type`: `text`, `number`, `textarea`, `date`, `select`
- `required`: булево значение (обязательное поле)
- `options`: массив строк (для типа `select`)
- `placeholder`: подсказка

Пример:

```javascript
{ name: 'companyName', label: 'Название компании', type: 'text', required: true }
```

## Хранение файлов

Загруженные файлы сохраняются в директории `uploads/` на хосте, которая монтируется в контейнеры Node.js и Nginx. Эта директория **не** находится под версионным контролем – регулярно создавайте её резервные копии.

## Рекомендации по резервному копированию

- **База данных:** регулярно выполняйте `pg_dump`.
- **Загрузки:** используйте `rsync` или инструменты резервного копирования для копирования папки `uploads/` в другое место.

## Устранение неполадок

- **Конфликт портов:** если порт 80 или 5432 уже занят, измените порты хоста в `docker-compose.yml`.
- **Фронтенд не обновляется:** пересоберите фронтенд и перезапустите Nginx: `docker-compose restart nginx`.
- **Отказ в подключении к БД:** убедитесь, что сервис `db` запущен и порт правильно проброшен.

